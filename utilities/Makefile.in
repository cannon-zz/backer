#
# Here we go...
#

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
DESTDIR =

TARGETS = bkrcheck bkrencode
SOURCES = bkr_disp_mode.c bkr_proc_io.c bkr_puts.c bkrcheck.c bkrencode.c \
	  bkr_stdio_dev.c \
	  ../drivers/bkr_stream.c \
          ../drivers/bkr_ring_buffer.c \
          ../codecs/bkr_frame.c \
          ../codecs/bkr_gcr.c \
          ../codecs/bkr_splp.c \
          ../codecs/bkr_splp_randomize.c \
	  ../codecs/bkr_ecc2.c \
          ../codecs/rs.c

ifneq (@GTK_VERSION@,no)
	TARGETS += bkrmonitor
	SOURCES += bkrmonitor.c
endif

CFLAGS  = -O3 -Wall -Wcast-align -Wstrict-prototypes -Wno-unused-function
CFLAGS += -I. -I../drivers -I../codecs -D_REENTRANT -DDEFAULT_DEVICE=\"@DEFAULT_DEV@\" @GTK_CFLAGS@
LDFLAGS = -lpthread @GTK_LIBS@

MAN_PAGES = $(TARGETS:%=%.8)

.PHONY : all install uninstall clean distclean realclean

all : $(TARGETS)


bkrcheck : bkrcheck.o bkr_disp_mode.o bkr_puts.o bkr_proc_io.o bkr_splp_randomize.o


bkrencode : bkrencode.o bkr_disp_mode.o bkr_proc_io.o bkr_stdio_dev.o \
            bkr_stream.o bkr_ring_buffer.o bkr_frame.o bkr_gcr.o bkr_splp.o \
            bkr_splp_randomize.o bkr_ecc2.o rs.o


bkrmonitor : bkrmonitor.o bkr_proc_io.o


%.o :
	@CC@ $(CFLAGS) -c -o $@ $<


depend : $(SOURCES)
	@CC@ $(CFLAGS) -MM $(SOURCES) >depend

include depend


uninstall :
	@echo -e "\nUninstalling utilities..."
	-rm -f $(TARGETS:%=$(DESTDIR)$(bindir)/%)
	-rm -f $(MAN_PAGES:%=$(DESTDIR)$(mandir)/man8/%*)
	@echo -e "Done.\n"


install : all
	@echo -e "\nInstalling utilities..."
	@INSTALL@ -d -m 0755 $(DESTDIR)$(bindir)
	@INSTALL@ -d -m 0755 $(DESTDIR)$(mandir)/man8
	for x in $(TARGETS) ; do \
	   @INSTALL@ -m 0755 $${x} $(DESTDIR)$(bindir) && \
	   @INSTALL@ -m 0644 DOCUMENTATION/$${x}.8 $(DESTDIR)$(mandir)/man8 && \
	   @GZIP@ $(DESTDIR)$(mandir)/man8/$${x}.8 ; \
	done
	@echo -e "Done.\n"


benchmark : all
	@echo "Testing 512MB..."
	@echo -n "Encoding baseline:"
	@time dd bs=1048576 count=512 </dev/zero 2>/dev/null >/dev/null
	@echo
	@echo -n "Encoding time:"
	@time dd bs=1048576 count=512 </dev/zero 2>/dev/null | ./bkrencode -Vn -Dh -Fs >/dev/null
	@echo
	@echo -n "Decoding baseline:"
	@time dd bs=1048576 count=512 </dev/zero 2>/dev/null | ./bkrencode -Vn -Dh -Fs | ../diagnostics/bkrnoise -Vn -Dh -Fs >/dev/null
	@echo
	@echo -n "Decoding time: "
	@time dd bs=1048576 count=512 </dev/zero 2>/dev/null | ./bkrencode -Vn -Dh -Fs | ../diagnostics/bkrnoise -Vn -Dh -Fs | ./bkrencode -u -Vn -Dh -Fs >/dev/null


clean :
	rm -f *.o core

distclean : clean
	rm -f $(TARGETS) $(MAN_PAGES:%=DOCUMENTATION/%) Makefile depend

realclean : distclean
